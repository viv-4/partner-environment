version: "3.7"

networks:
  placeos:
    name: placeos
    driver: bridge
    ipam:
      driver: default
      config:
      - subnet: 172.31.231.0/24

volumes:
  www:

# YAML Anchors

x-deployment-env: &deployment-env
  ENV: ${ENV:-development}
  SG_ENV: ${SG_ENV:-development}
  TZ: $TZ

x-jwt-public: &jwt-public .env.public_key

x-jwt-secret: &jwt-secret .env.secret_key

x-elastic-client-env: &elastic-client-env
  ES_HOST: ${ELASTIC_HOST:-elastic}
  ES_PORT: ${ELASTIC_PORT:-9200}

x-etcd-client-env: &etcd-client-env
  ETCD_HOST: ${ETCD_HOST:-etcd}
  ETCD_PORT: ${ETCD_PORT:-2379}

x-influxdb-api-key: &influxdb-api-key .env.influxdb

x-influxdb-client-env: &influxdb-client-env
  INFLUX_BUCKET: ${INFLUX_BUCKET:-place}
  INFLUX_HOST: ${INFLUX_HOST:-influxdb}
  INFLUX_ORG: ${INFLUX_ORG:-PlaceOS}

x-place-loader-client-env: &place-loader-client-env
  PLACE_LOADER_URI: ${PLACE_LOADER_URI:-http://frontends:3000}

x-redis-client-env: &redis-client-env
  REDIS_URL: ${REDIS_URL:-redis://redis:6379}

x-rethinkdb-client-env: &rethinkdb-client-env
  RETHINKDB_HOST: ${RETHINKDB_HOST:-rethink}
  RETHINKDB_PORT: ${RETHINKDB_PORT:-28015}
  RETHINKDB_DB: ${RETHINKDB_DB:-place_development}

x-rubber-soul-client-env: &rubber-soul-client-env
  RUBBER_SOUL_URI: ${RUBBER_SOUL_URI:-http://rubber-soul:3000}

x-smtp-client-env: &smtp-client-env
  SMTP_SERVER: ${SMTP_SERVER}
  SMTP_PORT: ${SMTP_PORT:-587}
  SMTP_USER: ${SMTP_USER}      # username if required, will not authenticate if blank
  SMTP_PASS: ${SMTP_PASS}      # password if required
  SMTP_SECURE: ${SMTP_SECURE}  # blank for unsecure, `SMTPS` for TLS, `STARTTLS` for negotiating TLS on unsecure connection

services:

  # Services

  api: # Rest API
    image: placeos/rest-api:${PLACE_REST_API_TAG:-latest}
    restart: always
    container_name: api
    hostname: api
    ports:
      - 127.0.0.1:8082:3000
    networks:
      placeos:
        ipv4_address: 172.31.231.2
    depends_on:
      - auth
      - elastic
      - etcd
      - redis
      - rethink
      - rubber-soul
    env_file:
      - *jwt-public
      - *jwt-secret
    environment:
      # Environment
      << : *deployment-env
      # Service Hosts
      << : *elastic-client-env
      << : *etcd-client-env
      << : *place-loader-client-env
      << : *redis-client-env
      << : *rethinkdb-client-env
      << : *rubber-soul-client-env

  auth: # Authentication Service
    image: placeos/auth:${PLACE_AUTH_TAG:-latest}
    restart: always
    container_name: auth
    hostname: auth
    ports:
      - 127.0.0.1:8081:8080
    networks:
      placeos:
        ipv4_address: 172.31.231.3
    depends_on:
      - rethink
    env_file:
      - *jwt-secret
    environment:
      << : *rethinkdb-client-env
      COAUTH_NO_SSL: "true"
      TZ: $TZ

  core: # Module coordinator
    image: placeos/core:${PLACE_CORE_TAG:-latest}
    restart: always
    container_name: core
    hostname: core
    ports:
      - 127.0.0.1:8083:3000
    networks:
      placeos:
        ipv4_address: 172.31.231.4
    depends_on:
      - etcd
      - redis
      - rethink
    volumes:
      - ./data/core-drivers:/app/bin/drivers:Z
    environment:
      # Service Hosts
      << : *etcd-client-env
      << : *redis-client-env
      << : *rethinkdb-client-env
      # Environment
      << : *deployment-env

  frontends: # Frontend deployment service
    image: placeos/frontends:${PLACE_FRONTENDS_TAG:-latest}
    restart: always
    container_name: frontends
    hostname: frontends
    ports:
      - 127.0.0.1:8087:3000
    networks:
      placeos:
        ipv4_address: 172.31.231.5
    volumes:
      - type: volume
        source: www
        target: /app/www
    depends_on:
      - rethink
    environment:
      PLACE_LOADER_WWW: www
      << : *rethinkdb-client-env
      # Environment
      << : *deployment-env

  source:
    image: docker.io/placeos/source:${PLACE_SOURCE_TAG:-latest}
    restart: always
    container_name: source
    ports:
      - 127.0.0.1:8089:3000
    networks:
      placeos:
        ipv4_address: 172.31.231.15
    depends_on:
      - redis
      - rethink
      - influxdb
    env_file:
      - *influxdb-api-key
    environment:
      # Service Hosts
      << : *influxdb-client-env
      << : *redis-client-env
      << : *rethinkdb-client-env
      # Environment
      << : *deployment-env

  triggers: # Conditional execution service
    image: placeos/triggers:${PLACE_TRIGGERS_TAG:-latest}
    restart: always
    container_name: triggers
    hostname: triggers
    ports:
      - 127.0.0.1:8088:3000
    networks:
      placeos:
        ipv4_address: 172.31.231.6
    depends_on:
      - etcd
      - redis
      - rethink
    environment:
      # Service Hosts
      << : *etcd-client-env
      << : *redis-client-env
      << : *rethinkdb-client-env
      << : *smtp-client-env
      # Environment
      << : *deployment-env

  # Support

  init:
    image: placeos/init:${PLACE_INIT_TAG:-latest}
    container_name: init
    restart: on-failure
    networks:
      placeos:
        ipv4_address: 172.31.231.7
    depends_on:
      - rubber-soul
    environment:
      # User/Application Configuration
      PLACE_DOMAIN: ${PLACE_DOMAIN:-localhost:8443}
      PLACE_APPLICATION: ${PLACE_APPLICATION:-backoffice}
      PLACE_AUTH_HOST: ${PLACE_AUTH_HOST:-auth:8080}
      PLACE_USERNAME: ${PLACE_USERNAME:-Place Support (localhost:8443)}
      PLACE_EMAIL: ${PLACE_EMAIL:-support@place.tech}
      PLACE_PASSWORD: ${PLACE_PASSWORD:-development}
      PLACE_TLS: ${PLACE_TLS:-true}
      # Service Hosts
      << : *rethinkdb-client-env
      << : *elastic-client-env
      # Environment
      << : *deployment-env

  rubber-soul: # RethinkDB to Elasticsearch Service
    image: placeos/rubber-soul:${PLACE_RUBBER_SOUL_TAG:-latest}
    restart: always
    container_name: rubber-soul
    hostname: rubber-soul
    ports:
      - 127.0.0.1:8084:3000
    networks:
      placeos:
        ipv4_address: 172.31.231.8
    depends_on:
      - elastic
      - rethink
    environment:
      # Service Hosts
      << : *rethinkdb-client-env
      << : *elastic-client-env
      # Environment
      << : *deployment-env

  dispatch: # Engine driver server registration and data routing
    image: placeos/dispatch:${PLACE_DISPATCH_TAG:-latest}
    restart: always
    container_name: dispatch
    hostname: dispatch
    ports:
      - 127.0.0.1:8086:8080
    networks:
      placeos:
        ipv4_address: 172.31.231.9
    environment:
      SERVER_SECRET: ${PLACE_SERVER_SECRET:-development}

  # Resources

  elastic:
    image: blacktop/elasticsearch:${ELASTIC_VERSION:-7.6}
    restart: always
    container_name: elastic
    hostname: elastic
    ports:
      - 127.0.0.1:8090:9200
    networks:
      placeos:
        ipv4_address: 172.31.231.10
    volumes:
      - ./data/elastic-data:/usr/share/elasticsearch/data:Z
    environment:
      bootstrap.memory_lock: "true"
      cluster.routing.allocation.disk.threshold_enabled: "false"
      discovery.type: single-node
      TZ: $TZ

  etcd:
    image: bitnami/etcd:${ETCD_VERSION:-3.3.13}
    restart: always
    container_name: etcd
    hostname: etcd
    ports:
      - 127.0.0.1:8091:2379
      - 127.0.0.1:8092:2380
    networks:
      placeos:
        ipv4_address: 172.31.231.11
    healthcheck:
      test: wget --quiet --spider 172.31.231.11:2379/metrics
    volumes:
      - ./data/etcd-data:/etcd-data
    environment:
      ALLOW_NONE_AUTHENTICATION: "yes"
      TZ: $TZ
      ETCD_DATA_DIR: /etcd-data
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://172.31.231.11:2380
      ETCD_LISTEN_PEER_URLS: http://172.31.231.11:2380
      ETCD_LISTEN_CLIENT_URLS: http://172.31.231.11:2379,http://127.0.0.1:2379
      ETCD_ADVERTISE_CLIENT_URLS: http://172.31.231.11:2379
      ETCD_INITIAL_CLUSTER_TOKEN: cluster-1
      ETCD_INITIAL_CLUSTER: "infra0=http://172.31.231.11:2380,infra1=http://172.31.231.21:2380"
      ETCD_INITIAL_CLUSTER_STATE: new
      ETCD_NAME: infra0

  etcd2:
    image: bitnami/etcd:${ETCD_VERSION:-3.3.13}
    restart: always
    container_name: etcd2
    hostname: etcd2
    ports:
      - 127.0.0.1:8051:2379
      - 127.0.0.1:8052:2380
    networks:
      placeos:
        ipv4_address: 172.31.231.21
    healthcheck:
      test: wget --quiet --spider 172.31.231.21:2379/metrics
    volumes:
      - ./data/etcd2-data:/etcd-data
    environment:
      ALLOW_NONE_AUTHENTICATION: "yes"
      TZ: $TZ
      ETCD_DATA_DIR: /etcd-data
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://172.31.231.21:2380
      ETCD_LISTEN_PEER_URLS: http://172.31.231.21:2380
      ETCD_LISTEN_CLIENT_URLS: http://172.31.231.21:2379,http://127.0.0.1:2379
      ETCD_ADVERTISE_CLIENT_URLS: http://172.31.231.21:2379
      ETCD_INITIAL_CLUSTER_TOKEN: cluster-1
      ETCD_INITIAL_CLUSTER: "infra0=http://172.31.231.11:2380,infra1=http://172.31.231.21:2380"
      ETCD_INITIAL_CLUSTER_STATE: new
      ETCD_NAME: infra1

  influxdb:
    image: quay.io/influxdb/influxdb:${INFLUXDB_IMAGE_TAG-2.0.0-beta}
    container_name: influx
    restart: always
    networks:
      placeos:
        ipv4_address: 172.31.231.16
    ports:
      - 127.0.0.1:9999:9999
    hostname: influx
    healthcheck:
      test: influx bucket list
    volumes:
      - ./data/influx-data:/root/.influxdbv2
    command: "--reporting-disabled"

  nginx:
    image: ubergarm/openresty-nginx-jwt
    restart: always
    container_name: nginx
    hostname: nginx
    ports:
      - 8080:80
      - 8443:443
    networks:
      placeos:
        ipv4_address: 172.31.231.12
    depends_on:
      - auth
      - api
    volumes:
      - ./config/nginx/nginx.conf:/nginx.conf:Z
      - ./config/nginx/bearer.lua:/bearer.lua:Z
      - ./ssl/:/etc/nginx/ssl/:Z
      - type: volume
        source: www
        target: /etc/nginx/html/
        read_only: true
    env_file:
      - *jwt-public
      - *influxdb-api-key
    environment:
      TZ: $TZ

  redis:
    image: eqalpha/keydb
    restart: always
    container_name: redis
    hostname: redis
    ports:
      - 127.0.0.1:7379:6379
    networks:
      placeos:
        ipv4_address: 172.31.231.13
    volumes:
      - ./data/redis-data:/data:Z
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf:Z
    environment:
      TZ: $TZ

  rethink:
    image: rethinkdb:${RETHINKDB_VERSION:-2.4}
    restart: always
    container_name: rethink
    hostname: rethink
    ports:
      - 127.0.0.1:8093:8080
    networks:
      placeos:
        ipv4_address: 172.31.231.14
    volumes:
      - ./data/rethink-data:/data/rethinkdb_data/:Z
    environment:
      TZ: $TZ
